class ElementHandler {
  element(element: Element) {
    if (element.tagName === 'iframe') {
      element.remove();
    }

    if (element.tagName === 'link' && element.getAttribute('rel') === 'modulepreload') {
      element.remove();
    }

    if (element.tagName === "script" && element.getAttribute("data-ad-client") === "ca-pub-3681824626260772") {
      element.setAttribute('data-ad-client', 'ca-pub-9817119432389293');
      return
    }

    if (element.tagName === "script" && element.getAttribute("src") === "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js") {
      return
    }

    if (element.tagName === "script" && (!element.hasAttribute("type") || (element.hasAttribute("type") && element.getAttribute("type") !== "application/ld+json"))) {
      element.remove();
    }
  }
}

class OtherElementHandler {
  element(element: Element) {
    if (element.tagName === "script" && element.getAttribute("data-ad-client") === "ca-pub-3681824626260772") {
      element.setAttribute('data-ad-client', 'ca-pub-9817119432389293');
      return
    }
  }
}

export async function handleRequest(req: Request) {
  const regex = new RegExp('(' + list.join('|') + ')', 'i');
  const isBot = regex.test(`${req.headers.get("User-Agent")}`);

  const res = await fetch(req);

  if (isBot) {
    return new HTMLRewriter()
      .on("link", new ElementHandler())
      .on("script", new ElementHandler())
      .on("iframe", new ElementHandler())
      .transform(res);
  }

  return new HTMLRewriter()
    .on("script", new OtherElementHandler())
    .transform(res);
}



const list = [
  " Daum/",
  " DeuSu/",
  " MuckRack/",
  " splash ",
  " Sysomos/",
  " um-LN/",
  "(^|\\s)Site",
  "\\(vBSEO\\;",
  "^&lt;",
  "^12345",
  "^<",
  "^\\!",
  "^\\[",
  "^Ace Explorer",
  "^acoon",
  "^ActiveBookmark",
  "^ActiveRefresh",
  "^ActiveWorlds",
  "^Ad Muncher",
  "^AddThis",
  "^AHC/",
  "^Amazon CloudFront",
  "^Anonymous_agent",
  "^Apache",
  "^ApplicationHealthService",
  "^asafaweb\\.com",
  "^asynchttp",
  "^axios/",
  "^Azureus",
  "^biglotron",
  "^binlar",
  "^Blackboard Safeassign",
  "^BlockNote.Net",
  "^Bloglines",
  "^Bloglovin/",
  "^Browsershots",
  "^btwebclient/",
  "^BUbiNG",
  "^CakePHP",
  "^Camo Asset Proxy",
  "^CATExplorador/\\d",
  "^ClamAV[\\s/]",
  "^Client",
  "^cobweb/",
  "^Custom$",
  "^DAP ",
  "^DavClnt",
  "^Digg",
  "^Dispatch/\\d",
  "^Disqus/",
  "^docomo/",
  "^drupact",
  "^Drupal",
  "^DuckDuckGo",
  "^eCatch/",
  "^Evernote Clip Resolver",
  "^facebook",
  "^Faraday",
  "^fasthttp$",
  "^FDM \\d",
  "^FDM/\\d",
  "^findlink",
  "^FlashGet",
  "^Friendica",
  "^GigablastOpenSource",
  "^Go \\d.\\d package http",
  "^Go-http-client",
  "^gooblog/",
  "^googal",
  "^Goose",
  "^Grammarly",
  "^GreenBrowser",
  "^Gregarius",
  "^GuzzleHttp",
  "^Hatena",
  "^Hexometer",
  "^Hobbit",
  "^Hotzonu",
  "^http",
  "^HubSpot",
  "^HWCDN/",
  "^ICE Browser",
  "^iframely/",
  "^infoX-WISG",
  "^INGRID/\\d",
  "^Integrity/",
  "^java",
  "^Jeode/",
  "^JetBrains",
  "^Jetty/",
  "^Jigsaw",
  "^libtorrent",
  "^libwww",
  "^Liferea",
  "^linkdex",
  "^LinkWalker",
  "^ltx71",
  "^lua-resty-http",
  "^lwp-",
  "^LWP::Simple",
  "^MailChimp\\.com$",
  "^Mechanize",
  "^metainspector/",
  "^MetaURI",
  "^Microsoft BITS",
  "^Microsoft Data",
  "^Microsoft Office Existence",
  "^Microsoft Office Protocol Discovery",
  "^Microsoft Windows Network Diagnostics",
  "^Microsoft-CryptoAPI",
  "^Microsoft-WebDAV-MiniRedir",
  "^Mixmax-LinkPreview",
  "^MixnodeCache/",
  "^Monit",
  "^MovableType",
  "^Mozilla/4\\.0 \\(compatible;\\)$",
  "^Mozilla/5\\.0 \\(compatible(; Optimizer)?\\)",
  "^Mozilla/5\\.0 \\(en-us\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Version/3\\.1 Safari/525\\.13",
  "^Mozilla/5\\.0 \\(Macintosh; Intel Mac OS X 10_15\\) AppleWebKit/605\\.1\\.15 \\(KHTML, like Gecko\\) Mobile/15E148 DuckDuckGo/7",
  "^Mozilla/5\\.0 \\(Windows; rv:\\d{2}\\.0\\) Gecko/20100101 Firefox/\\d{2}\\.0$",
  "^Mozilla/\\d\\.\\d \\(compatible\\)$",
  "^muCommander",
  "^My browser$",
  "^NaverMailApp",
  "^NetSurf",
  "^NetTrack Anonymous Web Statistics",
  "^Netvibes",
  "^NING",
  "^node-superagent",
  "^NokiaC3-00/5\\.0",
  "^NoteTextView",
  "^Nuzzel",
  "^Offline Explorer",
  "^okhttp",
  "^omgili",
  "^OSSProxy",
  "^panscient",
  "^Pcore-HTTP",
  "^PEAR HTTP_Request",
  "^photon/",
  "^PHP",
  "^Postman",
  "^postrank",
  "^python",
  "^RamblerMail",
  "^raynette_httprequest",
  "^RebelMouse",
  "^Riddler",
  "^Ruby$",
  "^Scrapy",
  "^selenium/",
  "^sentry/",
  "^SEOstats",
  "^set:",
  "^Shareaza",
  "^ShortLinkTranslate",
  "^SignalR",
  "^snap$",
  "^Snapchat",
  "^Space Bison",
  "^Spring ",
  "^Sprinklr",
  "^summify",
  "^SVN",
  "^T-Online Browser",
  "^Taringa",
  "^Test Certificate Info",
  "^The Knowledge AI",
  "^Thinklab",
  "^Traackr.com",
  "^Transmission",
  "^tumblr/",
  "^Typhoeus",
  "^Ubuntu APT-HTTP",
  "^UCmore",
  "^Upflow/",
  "^USER_AGENT",
  "^utorrent/",
  "^vBulletin",
  "^venus/fedoraplanet",
  "^VSE\\/",
  "^W3C",
  "^WebCopier",
  "^wget",
  "^whatsapp",
  "^WhatWeb",
  "^WWW-Mechanize",
  "^Xenu Link Sleuth",
  "^Xymon",
  "^Yahoo",
  "^Yandex",
  "^Zabbix",
  "^ZDM/\\d",
  "^Zend_Http_Client",
  "^Zjavascript",
  "^ZmEu$",
  "Abonti/",
  "adbeat\\.com",
  "amiga",
  "analyz",
  "AnyEvent-HTTP",
  "AppInsights",
  "archive",
  "Ask Jeeves/Teoma",
  "auto",
  "BingPreview",
  "Bluecoat DRTR",
  "BorderManager",
  "bot",
  "BrandVerity/",
  "BrowseX",
  "burpcollaborator",
  "capture",
  "Catchpoint",
  "check",
  "Chrome-Lighthouse",
  "chromeframe",
  "CloudFlare",
  "coccoc",
  "collect",
  "Commons-HttpClient",
  "crawl",
  "daemon",
  "DareBoost",
  "Datanyze",
  "dataprovider",
  "DejaClick",
  "detector",
  "DMBrowser",
  "Domains Project",
  "download",
  "Email",
  "Embedly",
  "feed",
  "fetch",
  "finder",
  "FirePHP",
  "FlipboardProxy/",
  "FreeSafeIP",
  "Genieo",
  "GetLinkInfo",
  "ghost",
  "GomezAgent",
  "google",
  "GroupHigh/",
  "GTmetrix",
  "HeadlessChrome/",
  "heritrix",
  "httrack",
  "HubSpot Marketing Grader",
  "Hydra",
  "ibisBrowser",
  "ichiro",
  "images",
  "index",
  "ips-agent",
  "java/",
  "JavaFX",
  "Jorgee",
  "kulturarw3/",
  "library",
  "link preview",
  "Lipperhey",
  "Lucidworks-Anda",
  "mail\\.ru/",
  "Miniflux/",
  "monitor",
  "NetcraftSurveyAgent/",
  "news",
  "Nmap Scripting Engine",
  "nutch",
  "OffByOne",
  "outbrain",
  "parse",
  "perl",
  "phantom",
  "PingAdmin",
  "Pingdom",
  "Powermarks",
  "PR-CY.RU",
  "prlog\\.ru",
  "proximic",
  "PTST[/ ]\\d",
  "Qwantify",
  "RankSonicSiteAuditor/",
  "reader",
  "Rigor",
  "Rivva",
  "rss",
  "scan",
  "ScoutJet",
  "scrape",
  "search",
  "server",
  "shrinktheweb\\.com",
  "SkypeUriPreview",
  "slurp",
  "Snacktory",
  "Sogou",
  "SpeedMode; Proxy;",
  "spider",
  "spy",
  "StatusCake",
  "stumbleupon\\.com",
  "SuperCleaner",
  "synapse",
  "synthetic",
  "thumb",
  "TinEye",
  "toolbar",
  "tracemyfile",
  "TrendsmapResolver",
  "tweetedtimes",
  "Twingly Recon",
  "url",
  "Vagabondo",
  "validator",
  "vkshare",
  "WAPCHOI",
  "Wappalyzer",
  "webcorp/",
  "WebDataStats/",
  "Webglance",
  "webkit2png",
  "WinHTTP",
  "wmtips.com/\\d",
  "woorankreview",
  "WordPress",
  "www\\.(ackerm|alertra|de|iskanie|megaproxy|moreover|mowser|nearsoftware|ssllabs)\\.com",
  "yeti",
  "zgrab"
];